{% extends 'webui/base.html' %}

{% load static %}

{% block extrahead %}
{{ liquidsoap_status|json_script:'liquidsoap-status-json' }}
<script>
  {% url 'status_boot' as boot_url %}
  {% url 'status_skip' as skip_url %}
  var statusBootUrl = '{{ boot_url|escapejs }}',
      statusSkipUrl = '{{ skip_url|escapejs }}',
      csrfToken = '{{ csrf_token|escapejs }}',
      showBoot = {{ perms.common.can_boot|yesno:'true,false' }},
      showBan = {{ user.is_superuser|yesno:'true,false' }},
      showSkip = {{ perms.broadcast.change_broadcast|yesno:'true,false' }}

</script>
<script src="{% static 'webui/js/handlebars.min.js' %}"></script>
<script src="{% static 'webui/js/status.js' %}"></script>
{% endblock %}

{% block content %}

{% verbatim %}
<script id="liquidsoap-status-template" type="text/x-handlebars-template">
<table>
  <caption>Harbor Information</caption>
  <tr>
    <td width="25%"><strong>Current Stream:</strong></td>
    <td width="75%">
      {{#each sources}}
        {{#if this.is_current_stream}}
          <strong class="green">{{this.name}}</strong>
        {{/if}}
      {{/each}}
      <em>(see below)</em>
    </td>
  </tr>
  <tr>
    <td><strong>Current Metadata:</strong></td>
    <td>
      {{#with metadata}}
        {{#if artist}}{{artist}}{{#if album}} - {{else}}{{#if title}} - {{/if}}{{/if}}{{/if}}
        {{#if album}}{{album}}{{#if title}} - {{/if}}{{/if}}
        {{#if title}}{{title}}{{/if}}
        {{#unless artist}}
          {{#unless album}}
            {{#unless title}}
              <em>none</em>
            {{/unless}}
          {{/unless}}
        {{/unless}}
      {{/with}}
    </td>
  </tr>
  <tr>
    <td><strong>Server Uptime:</strong></td>
    <td><code class="since-timer" data-since="{{server_info.start_time}}"></code></td>
  </tr>
  <tr>
    <td><strong>Liquidsoap Version:</strong></td>
    <td><code>v{{server_info.version}}</code></td>
  </tr>
</table>

{{#if sources}}
  <table>
    <caption>Harbor Sources</caption>
    <thead>
      <tr>
        <th{{#if showActions}} width="12%"{{/if}}>Precedence</th>
        <th{{#if showActions}} width="31%"{{/if}}>Source Name</th>
        <th {{#if showActions}}width="26%"{{else}}colspan="2"{{/if}}>Active</th>
        {{#if showActions}}
          <th width="30%">Actions</th>
        {{/if}}
      </tr>
    </thead>
    <tbody>
      {{#each sources}}
        {{#with this}}
          <tr{{#if is_current_stream}} class="green bold"{{/if}}>
            <td>{{precedence}}</td>

            <td>
              {{name}}
              {{#ifEqual id ../dj_harbor_source}}
                {{#if ../live_user}}
                  {{#with ../live_user}}
                    <span class="green">&mdash; DJ currently connected</span>
                    <ul>
                      <li>User: {{username}} {{#ifNotEqual username full_name}}({{full_name}}){{/ifNotEqual}}</li>
                      <li>Connected for <code class="since-timer" data-since="{{connected_since}}"></code></li>
                    <ul>
                  {{/with}}
                {{else}}
                  &mdash; No user connected
                {{/if}}
              {{/ifEqual}}
            </td>

            <td
            {{#if is_current_stream}}
              >
              Active &amp; streaming
            {{else}}
              {{#if is_active}}
                class="orange">
                Active, not streaming<br>
                (precedence too low)
              {{else}}
                class="red">Inactive (or silent)
              {{/if}}
            {{/if}}
            {{#with (lookup ../timed_sources [id])}}
              <br>
              <code class="track-end" data-end="{{this}}"></code> remaining of track
            {{/with}}
            </td>

            {{#if ../showActions}}
              <td>
                {{#ifContains ../skippable_sources id}}
                  {{#if ../showSkip}}
                    {{#if is_active}}
                      <button class="skip-btn bg-orange" data-name="{{name}}" data-id="{{id}}">Stop<br>(Skip Current Track)</button>
                    {{/if}}
                  {{/if}}
                {{/ifContains}}
                {{#ifEqual id ../dj_harbor_source}}
                  {{#with ../live_user}}
                    {{#if ../../showBoot}}
                      <button class="boot-btn" data-time="60" data-text="1 minute" data-name="{{username}}" data-id="{{user_id}}">
                        Ban {{username}} for 1 minute
                      </button>
                      <br>
                      <button class="boot-btn bg-orange" data-time="900" data-text="15 minutes" data-name="{{username}}" data-id="{{user_id}}">
                        Ban {{username}} for 15 minutes
                      </button>
                      <br>
                      <button class="boot-btn bg-orange" data-time="3600" data-text="1 hour" data-name="{{username}}" data-id="{{user_id}}">
                        Ban {{username}} for 1 hour
                      </button>
                    {{/if}}
                    {{#if ../../showBan}}
                      <br>
                      <button class="boot-btn bg-red" data-time="permanent" data-text="permanently" data-name="{{username}}" data-id="{{user_id}}">
                        Ban {{username}} <strong><u>PERMANENTLY</u></strong><br>
                        (sets harbor authorization to <em>never</em>)
                      </button>
                    {{/if}}
                  {{/with}}

                {{/ifEqual}}
              </td>
            {{/if}}
          </tr>
        {{/with}}
      {{/each}}
    </tbody>
  </table>
{{else}}
  <p class="error">The harbor appears to be down. Please try again later.</p>
{{/if}}
</script>
{% endverbatim %}
<div id="liquidsoap-status"></div>

<table>
  <caption>Current User</caption>
  {% for description, value in user_info %}
    <tr>
      <td><strong>{{ description }}</strong></td>
      <td>{{ value }}</td>
    </tr>
  {% endfor %}
</table>
</div>

{# TODO: make this a separate view #}
{% comment %}
{% if config.GOOGLE_CALENDAR_ENABLED and user.harbor_auth != user.HarborAuth.NEVER %}
  <details>
    <summary>
      {{ user.show_times|length }} Google Calendar show time{{ user.show_times|pluralize }}
      from {{ show_times_range_start }} to {{ show_times_range_end }}
    </summary>
    {% if user.harbor_auth == user.HarborAuth.ALWAYS %}
      <p><em>Note: you are <u>always</u> authorized to broadcast on the harbor.</em></p>
    {% endif %}
    {% if user.show_times %}
      {# TODO: Filter these shows times by today final show, not all days, if NOW >= lower bound #}
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Start Time</th>
            <th>End Time</th></tr>
        </thead>
        <tbody>
          {% for show_time in user.show_times %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ show_time.lower }}</td>
              <td>{{ show_time.upper }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No show times scheduled.</p>
    {% endif %}
  </details>
{% endif %}
{% endcomment %}
{% endblock %}
